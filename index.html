<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fahh ðŸ’¨</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#000000" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="Fahh" />
    <link rel="apple-touch-icon" href="icon-192.png" />

    <style>
      * {
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
        font-family: "Comic Sans MS", "Comic Sans", monospace;
        background: black;
      }

      canvas {
        width: 100vw;
        height: 100vh;
        position: absolute;
        z-index: 10;
        touch-action: none;
        user-select: none;
      }

      footer {
        position: absolute;
        bottom: 10px;
        right: 10px;
        color: white;
        z-index: 999;
      }

      #hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: white;
        pointer-events: none;
        transition: opacity 0.5s;
      }

      footer a {
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="hint">
      <h1>Tap to Fahh ðŸ’¨</h1>
    </div>

    <canvas></canvas>

    <footer>
      Made with ðŸ’¨ by
      <a href="https://twitter.com/itsKanishkP">Kanishk Pachauri</a> - Source on
      <a href="https://github.com/Mr-Sunglasses/fahh">GitHub</a>
    </footer>
  </body>
</html>

<script>
  const canvas = document.querySelector("canvas");
  const ctx = canvas.getContext("2d");
  const hint = document.getElementById("hint");

  const resize = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  };
  window.addEventListener("resize", resize);
  resize();

  // --- Audio: pre-fetch MP3 data immediately (no user interaction needed for fetch) ---
  const audioFetchPromise = fetch("fahh.mp3").then((r) => r.arrayBuffer());

  let audioCtx = null;
  let audioBuffer = null;
  let audioInitPromise = null;

  // Called on first interaction to create AudioContext and decode the buffer once.
  // Subsequent calls return immediately because audioBuffer is already set.
  function ensureAudio() {
    if (audioBuffer) return Promise.resolve();
    if (audioInitPromise) return audioInitPromise;
    // Create AudioContext synchronously inside the user gesture so it starts as "running".
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    audioInitPromise = audioFetchPromise.then((arrayBuffer) => {
      // Use callback form for Safari compatibility (old WebKit ignores the return value).
      return new Promise((resolve, reject) => {
        audioCtx.decodeAudioData(arrayBuffer, resolve, reject);
      });
    }).then((decoded) => {
      audioBuffer = decoded;
    });
    return audioInitPromise;
  }

  // Play a fresh buffer-source node each time â€” zero lag after first call.
  function sayFahh() {
    ensureAudio()
      .then(() => {
        if (audioCtx.state === "suspended") return audioCtx.resume();
      })
      .then(() => {
        const source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioCtx.destination);
        source.start(0);
      })
      .catch(() => {
        // Fallback for browsers without Web Audio API
        new Audio("fahh.mp3").play().catch(() => {});
      });
  }

  // --- Interaction handler (shared by pointer and touch) ---
  let hintHidden = false;

  function handleInteraction(x, y) {
    if (!hintHidden) {
      hint.style.opacity = "0";
      hintHidden = true;
    }

    const angleInRadians = Math.random() * Math.PI * 2;
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angleInRadians);
    ctx.font = "bold 64px 'Comic Sans MS', 'Comic Sans', monospace";
    ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 65%)`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("FAHH", 0, 0);
    ctx.restore();

    sayFahh();
  }

  // pointerdown works for both mouse and touch with no 300ms delay.
  canvas.addEventListener("pointerdown", (event) => {
    event.preventDefault();
    handleInteraction(event.offsetX, event.offsetY);
  });

  // --- Service Worker ---
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("sw.js").catch(() => {});
    });
  }
</script>
